import numpy as np
import pandas as pd
from typing import Dict, Any
import logging

logger = logging.getLogger(__name__)

class 经济智能体:
    """经济智能体类，负责模拟经济变化"""
    
    def __init__(self, 初始数据: Dict[str, Any]):
        """初始化经济智能体
        
        Args:
            初始数据: 包含初始经济数据的字典
        """
        self.状态 = {
            'GDP': 初始数据.get('GDP', 1000000),  # 亿元
            '第一产业占比': 初始数据.get('第一产业占比', 0.07),
            '第二产业占比': 初始数据.get('第二产业占比', 0.39),
            '第三产业占比': 初始数据.get('第三产业占比', 0.54),
            '技术进步率基准': 初始数据.get('技术进步率基准', 0.02),
            '资本存量': 初始数据.get('资本存量', 2000000),  # 亿元
            '投资率': 初始数据.get('投资率', 0.43),
            '消费率': 初始数据.get('消费率', 0.54),
            '出口依存度': 初始数据.get('出口依存度', 0.18)
        }
    
    def 获取状态(self) -> Dict[str, Any]:
        """获取当前状态
        
        Returns:
            包含当前状态的字典
        """
        return self.状态.copy()
    
    def 更新状态(self, 人口数据: Dict[str, Any], 社保缴费率: float,
               教育水平: float, 外部冲击: Dict[str, float] = None) -> Dict[str, Any]:
        """更新经济状态
        
        Args:
            人口数据: 包含人口相关数据的字典
            社保缴费率: 社会保障缴费率（0-1之间）
            教育水平: 人口教育水平（0-1之间）
            外部冲击: 外部冲击影响系数字典
            
        Returns:
            更新后的状态字典
        """
        try:
            if 外部冲击 is None:
                外部冲击 = {}
            
            # 1. 计算劳动力供给
            劳动力 = 人口数据['劳动年龄人口'] * 0.8  # 假设80%的劳动年龄人口参与工作
            
            # 2. 计算全要素生产率增长
            技术进步率 = (self.状态['技术进步率基准'] * 
                         (1 + 教育水平 * 0.5) *  # 教育水平提升技术进步
                         (1 + 外部冲击.get('产业升级率', 0.0)))  # 外部冲击影响
            
            # 3. 计算产业结构调整
            产业结构调整系数 = 1 + 技术进步率
            新第一产业占比 = self.状态['第一产业占比'] / 产业结构调整系数
            新第二产业占比 = self.状态['第二产业占比'] * (1 - 技术进步率 * 0.2)
            新第三产业占比 = 1 - 新第一产业占比 - 新第二产业占比
            
            # 4. 计算投资变化
            投资率调整 = (1 + 外部冲击.get('GDP增长率调整', 0.0) -
                         社保缴费率 * 0.2)  # 社保缴费影响投资意愿
            新投资率 = min(0.5, max(0.3, self.状态['投资率'] * 投资率调整))
            
            # 5. 计算资本存量变化
            资本折旧率 = 0.05
            新增投资 = self.状态['GDP'] * 新投资率
            新资本存量 = (self.状态['资本存量'] * (1 - 资本折旧率) + 
                         新增投资)
            
            # 6. 计算GDP增长
            # 使用Cobb-Douglas生产函数：Y = A * K^α * L^(1-α)
            α = 0.4  # 资本产出弹性
            A = 1 * (1 + 技术进步率)  # 全要素生产率
            新GDP = (A * 
                    (新资本存量 ** α) * 
                    (劳动力 ** (1 - α)))
            
            # 7. 调整消费和出口
            新消费率 = min(0.65, self.状态['消费率'] * 
                         (1 + 外部冲击.get('GDP增长率调整', 0.0)))
            新出口依存度 = max(0.15, self.状态['出口依存度'] * 
                             (1 + 外部冲击.get('GDP增长率调整', 0.0)))
            
            # 8. 更新状态
            新状态 = {
                'GDP': 新GDP,
                '第一产业占比': 新第一产业占比,
                '第二产业占比': 新第二产业占比,
                '第三产业占比': 新第三产业占比,
                '技术进步率基准': self.状态['技术进步率基准'],
                '资本存量': 新资本存量,
                '投资率': 新投资率,
                '消费率': 新消费率,
                '出口依存度': 新出口依存度
            }
            
            self.状态 = 新状态
            return 新状态
            
        except Exception as e:
            logger.error(f"更新经济状态时出错: {str(e)}")
            raise 